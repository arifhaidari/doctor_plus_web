{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load doctor_tags %}
{% block title %}
Patient Detail | Doctor
{% endblock title %}
{% block breadcrumb %}
<div class="breadcrumb-bar">
  <div class="container-fluid">
    <div class="row align-items-center">
      <div class="col">
        <nav aria-label="breadcrumb" class="page-breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'doctor:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'doctor:my_patient' %}">My Patients</a></li>
            <li class="breadcrumb-item"><a href="#">Patient Details</a></li>
          </ol>
        </nav>
        <h2 class="breadcrumb-title">
          Patient Details
        </h2>
      </div>
    </div>
  </div>
</div>
{% endblock breadcrumb %}
{% block content %}
<!-- Page Content -->
<div class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-5 col-lg-4 col-xl-3 theiaStickySidebar dct-dashbd-lft">
        <!-- Profile Widget -->
        <div class="card widget-profile pat-widget-profile">
          <div class="card-body">
            <div class="pro-widget-content">
              <div class="profile-info-widget">
                <a href="#" class="booking-doc-img">
                  <img src="{% if patient.user.avatar %}{{ patient.user.avatar.url }}{% else %}{% if patient.user.gender == 'Male' %}{% static 'img/male_profile.png' %}{% else %}{% static 'img/female_profile.png' %}{% endif %}{% endif %}" alt="User Image">
                </a>
                <div class="profile-det-info">
                  <h3>{{ patient }}</h3>
                  <div class="patient-details">
                    <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> 
                      {% if patient.user.address %}
                      {{ patient.user.address.district.name }}, {{ patient.user.address.city.name }}
                      {% else %}
                      Unknown Address
                      {% endif %}
                      </h5>
                  </div>
                </div>
              </div>
            </div>
            <div class="patient-info">
              <ul>
                <li>Phone <span>{{ patient.user.phone }}</span></li>
                <li>Age <span>38 Years, Male</span></li>
                <li>Blood Group <span>AB+</span></li>
              </ul>
            </div>
          </div>
        </div>
        <!-- /Profile Widget -->
        <div style="height:25vh"></div>
      </div>
      <div class="col-md-7 col-lg-8 col-xl-9 dct-appoinment">
        <div class="card">
          <div class="card-body pt-0">
            <div class="user-tabs">
              <ul class="nav nav-tabs nav-tabs-bottom nav-justified flex-wrap">
                <li class="nav-item">
                  <a class="nav-link active" href="#pat_appointments" data-toggle="tab">Appointments</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#medical" data-toggle="tab"><span class="med-records">Medical Records</span></a>
                </li>
              </ul>
            </div>
            <div class="tab-content">
              <!-- Appointment Tab -->
              <div id="pat_appointments" class="tab-pane fade show active">
                <div class="card card-table mb-0">
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-hover table-center mb-0">
                        <thead>
                          <tr>
                            <th>{% trans "Patient" %}</th>
                            <th>{% trans "Appt Date" %}</th>
                            <th>{% trans "Booking Date" %}</th>
                            <th>{% trans "Clinic" %}</th>
                            <th>{% trans "Status" %}</th>
                            <th></th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for ap in appointments %}
                          <!-- when it's relative -->
                          {% if ap.relative is not None %}
                          <tr name="appoint_{{ap.id}}" class="canceld_appoinment">
                            <td>
                              <h2 class="table-avatar">
                                <a href="javascript:void(0);" class="avatar avatar-sm mr-2"><img class="avatar-img rounded-circle" src="{% if ap.relative.user.avatar %}{{ ap.relative.user.avatar.url }}{% else %}{% if ap.relative.user.gender == 'Male' %}{% static 'img/male_profile.png' %}{% else %}{% static 'img/female_profile.png' %}{% endif %}{% endif %}" alt="User Image"></a>
                                <a href="javascript:void(0);"> {{ ap.relative}} </a>
                              </h2>
                            </td>
                            <td>{{ ap.appt_date|date:"d. M, Y" }} <span class="d-block text-info">{{ ap.start_appt_time|default:"" }} - {{ ap.end_appt_time|default:"" }}</span></td>
                            <td>{{ ap.booked_at|date:"d. M, Y" }}<span class="d-block text-info">{{ ap.booked_at|timesince }} ago</span></td>
                            <td>{{ ap.clinic }}</td>
                            {% if ap.status == "COMPLETED" %}
                            <td><span class="badge badge-pill bg-success">{{ ap.status }}</span></td>
                            {% if not ap.feedback_status %}
                            <td>
                              <div class="table-action">
                                <a href="javascript:void(0);" class="btn btn-sm bg-info-light disabled">
                                  <i class="fa fa-star"></i> No Rating Yet
                                </a>
                                <a href="javascript:add_condition_thread({{ap.id}});" class="btn btn-sm bg-primary-light">
                                  <i class="fas fa-folder"></i> Condition Thread
                                </a>
                              </div>
                            </td>
                            {% else %}
                            <td>
                              <div class="table-action">
                                <a href="{% got_feedback ap.id %}" class="btn btn-sm bg-success-light">
                                  <i class="fa fa-star"></i> View Rating
                                </a>
                                <a href="javascript:add_condition_thread({{ap.id}});" class="btn btn-sm bg-primary-light">
                                  <i class="fas fa-folder"></i> Condition Thread
                                </a>
                              </div>
                            </td>
                            {% endif %}
                            {% elif ap.status == "EXPIRED" %}
                            <td><span class="badge badge-pill bg-danger">{{ ap.status }}</span></td>
                            {% elif ap.status == "PATIENT_CANCELED" %}
                            <td><span class="badge badge-pill bg-danger">{{ ap.status }}</span></td>
                            {% elif ap.status == "DOCTOR_CANCELED" %}
                            <td><span class="badge badge-pill bg-danger">{{ ap.status }}</span></td>
                            {% elif ap.status == "BOOKED" %}
                            <td><span class="badge badge-pill bg-warning">{{ ap.status }}</span></td>
                            <td>
                              <div class="table-action">
                                <a href="javascript:void(0);" class="btn btn-sm bg-danger-light" onclick="cancel_appointment({{ap.id}})">
                                  <i class="fa fa-times"></i> Cancel
                                </a>
                              </div>
                            </td>
                            {% elif ap.status == "PENDING" %}
                            <td><span class="badge badge-pill bg-info">{{ ap.status }}</span></td>
                            <td>
                              <div class="table-action">
                                <a href="javascript:void(0);" class="btn btn-sm bg-success-light">
                                  <i class="fas fa-check"></i> Approve
                                </a>
                                <a href="javascript:void(0);" class="btn btn-sm bg-danger-light" onclick="cancel_appointment({{ap.id}})">
                                  <i class="fa fa-times"></i> Cancel
                                </a>
                              </div>
                            </td>
                            {% endif %}
                          </tr>
                          <!-- /when it's relative -->
                          <!-- when not relative -->
                          {% elif ap.relative is None %}
                          <tr name="appoint_{{ap.id}}" class="canceld_appoinment">
                            <td>
                              <h2 class="table-avatar">
                                <a href="javascript:void(0);" class="avatar avatar-sm mr-2"><img class="avatar-img rounded-circle" src="{% if ap.patient.user.avatar %}{{ ap.patient.user.avatar.url }}{% else %}{% if ap.patient.user.gender == 'Male' %}{% static 'img/male_profile.png' %}{% else %}{% static 'img/female_profile.png' %}{% endif %}{% endif %}" alt="User Image"></a>
                                <a href="javascript:void(0);"> {{ ap.patient}} </a>
                              </h2>
                            </td>
                            <td>{{ ap.appt_date|date:"d. M, Y" }} <span class="d-block text-info">{{ ap.start_appt_time|default:"" }} - {{ ap.end_appt_time|default:"" }}</span></td>
                            <td>{{ ap.booked_at|date:"d. M, Y" }}<span class="d-block text-info">{{ ap.booked_at|timesince }} ago</span></td>
                            <td>{{ ap.clinic }}</td>
                            {% if ap.status == "COMPLETED" %}
                            <td><span class="badge badge-pill bg-success">{{ ap.status }}</span></td>
                            {% if not ap.feedback_status %}
                            <td>
                              <div class="table-action">
                                <a href="javascript:void(0);" class="btn btn-sm bg-info-light disabled">
                                  <i class="far fa-star"></i> No Rating
                                </a>
                                <a href="javascript:add_condition_thread({{ap.id}});" class="btn btn-sm bg-primary-light">
                                  <i class="fas fa-folder"></i> Condition Thread
                                </a>
                              </div>
                            </td>
                            {% else %}
                            <td>
                              <div class="table-action">
                                <a href="{% got_feedback ap.id %}" class="btn btn-sm bg-success-light">
                                  <i class="fa fa-star"></i> Rating
                                </a>
                                <a href="javascript:add_condition_thread({{ap.id}});" class="btn btn-sm bg-primary-light">
                                  <i class="fas fa-folder"></i> Condition Thread
                                </a>
                              </div>
                            </td>
                            {% endif %}
                            {% elif ap.status == "EXPIRED" %}
                            <td><span class="badge badge-pill bg-danger">{{ ap.status }}</span></td>
                            {% elif ap.status == "PATIENT_CANCELED" %}
                            <td><span class="badge badge-pill bg-danger">{{ ap.status }}</span></td>
                            {% elif ap.status == "DOCTOR_CANCELED" %}
                            <td><span class="badge badge-pill bg-danger">{{ ap.status }}</span></td>
                            {% elif ap.status == "BOOKED" %}
                            <td><span class="badge badge-pill bg-warning">{{ ap.status }}</span></td>
                            <td>
                              <div class="table-action">
                                <a href="javascript:void(0);" class="btn btn-sm bg-danger-light" onclick="cancel_appointment({{ap.id}})">
                                  <i class="fa fa-times"></i> Cancel
                                </a>
                              </div>
                            </td>
                            {% elif ap.status == "PENDING" %}
                            <td><span class="badge badge-pill bg-info">{{ ap.status }}</span></td>
                            <td>
                              <div class="table-action">
                                <a href="javascript:void(0);" class="btn btn-sm bg-success-light">
                                  <i class="fas fa-check"></i> Approve
                                </a>
                                <a href="javascript:void(0);" class="btn btn-sm bg-danger-light" onclick="cancel_appointment({{ap.id}})">
                                  <i class="fa fa-times"></i> Cancel
                                </a>
                              </div>
                            </td>
                            {% endif %}
                          </tr>
                          {% endif %}
                          <!-- end of relative if -->
                          {% empty %}
                          <tr>
                            <td>
                              <h3 align="center"> {% trans "No appoinments" %} </h3>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <!-- /Appointment Tab -->
              <!-- Medical Records Tab -->
              <div class="tab-pane fade" id="medical">
                <div class="text-right pb-3 mr-1">
                </div>
                <div class="card card-table mb-0">
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-hover table-center mb-0">
                        <thead>
                          <tr>
                            <th style="cursor:pointer;">Patient <i class="fa fa-sort teal-color"></i></th>
                            <th style="cursor:pointer;">Related Doctor <i class="fa fa-sort teal-color"></i></th>
                            <th style="cursor:pointer;">Title <i class="fa fa-sort teal-color"></i></th>
                            <th style="cursor:pointer;">timestamp <i class="fa fa-sort teal-color"></i></th>
                            <th style="cursor:pointer;">Attachment No <i class="fa fa-sort teal-color"></i></th>
                            <th class="text-center">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for md in medicalrecords %}
                          <tr name="record_{{ md.id }}">
                            <td>
                              <h2 class="table-avatar">
                                <a href="doctor-promd.html" class="avatar avatar-sm mr-2">
                                  <img class="avatar-img rounded-circle" src="{% if md.relative_or_self.user.avatar %}{{ md.relative_or_self.user.avatar.url }}{% else %}{% if md.relative_or_self.user.gender == 'Male' %}{% static 'img/male_profile.png' %}{% else %}{% static 'img/female_profile.png' %}{% endif %}{% endif %}" alt="User Image">
                                </a>
                                <a href="#"> {{ md.relative_or_self.user.full_name }}</a>
                              </h2>
                            </td>
                            <td>{{ md.related_doctor.user.full_name }}</td>
                            <td>{{ md.title }}</td>
                            <td>{{ md.timestamp|date:'d M Y' }}</td>
                            <td>{{ md.medicalrecordfile_set.all.count }}</td>
                            <td class="text-right">
                              <div class="table-action">
                                <a href="{% url 'medicalrecord:medical_detail' md.id %}" class="btn btn-sm bg-info-light">
                                  <i class="far fa-eye"></i> View
                                </a>
                              </div>
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <div class="pt-3">
                  <ul class="pagination">
                    {% if medicalrecords.has_previous %}
                    <li class="page-item">
                      <a class="page-link" href="?page=1" tabindex="-1">First</a>
                    </li>
                    {% endif %}
                    {% for num in medicalrecords.paginator.page_range %}
                    {% if num == medicalrecords.number %}
                    <li class="page-item active">
                      <a class="page-link" href="#">{{ num }} <span class="sr-only">(current)</span></a>
                    </li>
                    {% elif num > medicalrecords.number|add:'-3' and num < medicalrecords.number|add:'3' %} <li class="page-item"><a class="page-link" href="?page={{num}}">{{ num }}</a></li>
                      {% endif %}
                      {% endfor %}
                      {% if medicalrecords.has_next %}
                      <li class="page-item">
                        <a class="page-link" href="?page={{ medicalrecords.paginator.num_pages }}">Last</a>
                      </li>
                      {% endif %}
                  </ul>
                </div>
              </div>
              <!-- /Medical Records Tab -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- /Page Content -->
<!-- modals -->
<div class="modal fade custom-modal" id="add-condition-thread">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><b>Add Condition Thread</b></h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form method="post" id='submit-appointment-from' class="d-inline">
          {% csrf_token %}
          <label for="select-condition-thread">Select Condition Thread</label>
          <select name='condition_treated' id="select-condition-thread" multiple="multiple" style="width:90%;">
            {% for cn in appt_condition_treated %}
            <option value="{{cn.id}}" name="condition-thread-item">{{ cn }}</option>
            {% endfor %}
          </select>
          <span class="d-none" name='appid'></span>
        </form>
        <button class="btn btn-info" id='add-new-condition'><span class="fa fa-plus"></span></button>
        <div id="new-condition" class="pt-3">
          <hr>
          <h5><b>Add New Option</b></h5>
          <small>
            <p>If you can't find appointment threaded condition please add new option so that others can use it later too.</p>
          </small>
          <form action="." method="post" id="new_appointment_condition_thread_form">
            {% csrf_token %}
            {{ add_app_codition_thread.as_p }}
            <button type="submit" class="btn btn-primary"> Add </button>
            <button type="button" class="btn btn-warning" id='cancel-new-thread'> Cancel </button>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="submit_condtion_treated" class="btn btn-primary"> Submit </button>
      </div>
    </div>
  </div>
</div>
<!-- /modals -->
{% endblock content %}
{% block script %}
<script>
// cancel appointment
function cancel_appointment(app_id) {
  Swal.fire({
    title: 'Are you sure?',
    text: "You appointment will be canceled and other patient can book it!",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Yes, Cancel it!'
  }).then((result) => {
    if (result.isConfirmed) {
      let form = new FormData();
      form.append("csrfmiddlewaretoken", "{{ csrf_token }}");
      form.append('cancel_appointment', app_id)
      axios.post("{% url 'doctor:dashboard' %}", form).then((response) => {
    
        Swal.fire(
          'Appointment Canceled!',
          'Your file has been deleted.',
          'success'
        )
        
        $("tr[name='appoint_" + response.data.id + "']").addClass('canceld_appoinment')
        $("tr[name='appoint_" + response.data.id + "']").hide('slow')
      }).catch((error) => {
        console.error(error);
      });
    };
  });
};

// add appointment condition thread
function add_condition_thread(appid) {
  window.appid = appid;
  get_app_conditions();
  // $('#select-condition-thread').select2();
  $('#new-condition').hide('fast');
  $('#add-condition-thread').appendTo("body").modal('show');

}
$('#add-new-condition').click(function(event) {
  $('#new-condition').toggle('slow');
  $('#new_appointment_condition_thread_form').validate({
    submitHandler: function(form) {
      submit_new_appointment_condition_thread();
    },
    rules: {
      "farsi_name": "required",
      "pashto_name": "required",
    }
  });
});
$('#cancel-new-thread').click(function(event) {
  $('#new-condition').toggle('slow');
  $('#new_appointment_condition_thread_form').trigger("reset");
});
// submit new appointment condition thread
function submit_new_appointment_condition_thread() {
  let form = new FormData($('#new_appointment_condition_thread_form')[0]);
  form.append('new-condition', 1);
  axios.post("{% url 'doctor:add_app_condtition_thread' %}", form).then((response) => {
    if (response.data.status == "success") {
      location.reload();
    }
  }).catch((error) => {
    console.error(error);
  });
};
// submit appointment condition thread
$('#submit_condtion_treated').click(function(event) {
  let form = new FormData($("#submit-appointment-from")[0])
  form.append('appid', appid);
  axios.post(".", form).then((response) => {
    Swal.fire(
      'Condition Added!',
      'Appointment Condition Thread Added Successfully.',
      'success'
    );
  }).catch((error) => {
    console.error(error);
  });
});
// get appointment conditions
function get_app_conditions() {
  let form = new FormData();
  form.append('csrfmiddlewaretoken', '{{ csrf_token }}');
  form.append('app_conditions', 1);
  form.append('appid', appid);
  axios.post(".", form).then((response) => {
    let conditions = $("option[name='condition-thread-item']");
    $('#select-condition-thread').select2().val(response.data.conditions).trigger('change');
  }).catch((error) => {
    console.error(error);
  });
}
</script>
{% endblock script %}